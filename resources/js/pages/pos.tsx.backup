import AppLayout from '@/layouts/app-layout';
import { Head } from '@inertiajs/react';
import { useEffect, useState, useRef } from 'react';
import { type BreadcrumbItem } from '@/types';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { X, Plus, ShoppingCart, Scan, Trash2 } from 'lucide-react';
import { Label } from '@/components/ui/label';

const breadcrumbs: BreadcrumbItem[] = [
    {
        title: 'POS',
        href: '/pos',
    },
];

type CartItem = {
    id: number;
    nombre: string;
    sku?: string;
    precio_venta: number;
    iva_porcentaje: number;
    quantity: number;
    discount_percent?: number;
};

type Payment = {
    metodo: string;
    monto: number;
};

export default function PosPage() {
    const [products, setProducts] = useState<any[]>([]);
    const [cart, setCart] = useState<CartItem[]>([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [barcodeBuffer, setBarcodeBuffer] = useState('');
    const [payments, setPayments] = useState<Payment[]>([{ metodo: 'efectivo', monto: 0 }]);
    const [isPaymentOpen, setIsPaymentOpen] = useState(false);
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
    const [montoRecibido, setMontoRecibido] = useState<number>(0);
    const searchInputRef = useRef<HTMLInputElement>(null);
    const barcodeTimeoutRef = useRef<NodeJS.Timeout | null>(null);

    useEffect(() => {
        fetch('/api/productos')
            .then((r) => r.json())
            .then((data) => setProducts(data || []))
            .catch(() => {});
    }, []);

    // Listener para pistola l√°ser de c√≥digos de barras
    useEffect(() => {
        const handleKeyPress = (e: KeyboardEvent) => {
            // Si el usuario est√° escribiendo en un input, ignorar
            if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
                return;
            }

            // Enter indica fin de escaneo
            if (e.key === 'Enter' && barcodeBuffer.length > 0) {
                searchByBarcode(barcodeBuffer);
                setBarcodeBuffer('');
                if (barcodeTimeoutRef.current) {
                    clearTimeout(barcodeTimeoutRef.current);
                }
                return;
            }

            // Acumular caracteres del c√≥digo de barras
            if (e.key.length === 1) {
                setBarcodeBuffer(prev => prev + e.key);
                
                // Reset buffer despu√©s de 100ms de inactividad
                if (barcodeTimeoutRef.current) {
                    clearTimeout(barcodeTimeoutRef.current);
                }
                barcodeTimeoutRef.current = setTimeout(() => {
                    setBarcodeBuffer('');
                }, 100);
            }
        };

        window.addEventListener('keypress', handleKeyPress);
        return () => {
            window.removeEventListener('keypress', handleKeyPress);
            if (barcodeTimeoutRef.current) {
                clearTimeout(barcodeTimeoutRef.current);
            }
        };
    }, [barcodeBuffer, products]);

    const searchByBarcode = (barcode: string) => {
        const product = products.find(p => 
            p.sku?.toLowerCase() === barcode.toLowerCase() ||
            p.codigo_barras?.toLowerCase() === barcode.toLowerCase()
        );
        
        if (product) {
            addToCart(product);
            setMessage({ type: 'success', text: `‚úì ${product.nombre} agregado` });
            setTimeout(() => setMessage(null), 2000);
        } else {
            setMessage({ type: 'error', text: `C√≥digo "${barcode}" no encontrado` });
            setTimeout(() => setMessage(null), 2000);
        }
    };

    const filteredProducts = products.filter((p) =>
        p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
        p.sku?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const addToCart = (product: any) => {
        const existing = cart.find((item) => item.id === product.id);
        if (existing) {
            setCart(
                cart.map((item) =>
                    item.id === product.id
                        ? { ...item, quantity: item.quantity + 1 }
                        : item
                )
            );
        } else {
            setCart([
                ...cart,
                {
                    id: product.id,
                    nombre: product.nombre,
                    sku: product.sku,
                    precio_venta: product.precio_venta,
                    iva_porcentaje: product.iva_porcentaje || 0,
                    quantity: 1,
                    discount_percent: 0,
                },
            ]);
        }
    };

    const clearCart = () => {
        setCart([]);
        setMessage({ type: 'success', text: 'Carrito limpiado' });
        setTimeout(() => setMessage(null), 2000);
    };

    const removeFromCart = (id: number) => {
        setCart(cart.filter((item) => item.id !== id));
    };

    const updateQuantity = (id: number, quantity: number) => {
        if (quantity <= 0) {
            removeFromCart(id);
        } else {
            setCart(
                cart.map((item) =>
                    item.id === id ? { ...item, quantity } : item
                )
            );
        }
    };

    const calculateTotals = () => {
        let subtotal = 0;
        let taxAmount = 0;
        
        cart.forEach((item) => {
            const itemSubtotal = item.precio_venta * item.quantity;
            const discount = itemSubtotal * ((item.discount_percent || 0) / 100);
            const afterDiscount = itemSubtotal - discount;
            const tax = afterDiscount * (item.iva_porcentaje / 100);
            
            subtotal += afterDiscount;
            taxAmount += tax;
        });

        return {
            subtotal: Math.round(subtotal * 100) / 100,
            tax: Math.round(taxAmount * 100) / 100,
            total: Math.round((subtotal + taxAmount) * 100) / 100,
        };
    };

    const totals = calculateTotals();

    const handlePaymentChange = (index: number, field: string, value: any) => {
        const newPayments = [...payments];
        newPayments[index] = { ...newPayments[index], [field]: value };
        setPayments(newPayments);
    };

    const addPaymentMethod = () => {
        setPayments([...payments, { metodo: 'efectivo', monto: 0 }]);
    };

    const removePaymentMethod = (index: number) => {
        if (payments.length > 1) {
            setPayments(payments.filter((_, i) => i !== index));
        }
    };

    const submitSale = async () => {
        if (cart.length === 0) {
            setMessage({ type: 'error', text: 'El carrito est√° vac√≠o' });
            return;
        }

        const totalPayments = payments.reduce((sum, p) => sum + (p.monto || 0), 0);
        if (Math.abs(totalPayments - totals.total) > 0.01) {
            setMessage({ type: 'error', text: `Los pagos no coinciden con el total (${totals.total})` });
            return;
        }

        setLoading(true);
        try {
            const response = await fetch('/api/pos/ventas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: cart.map((item) => ({
                        producto_id: item.id,
                        cantidad: item.quantity,
                        precio_unitario: item.precio_venta,
                        descuento_porcentaje: item.discount_percent || 0,
                    })),
                    pagos: payments.map((p) => ({
                        metodo: p.metodo,
                        monto: p.monto,
                    })),
                }),
            });

            if (response.ok) {
                const data = await response.json();
                setMessage({ type: 'success', text: 'Venta registrada exitosamente' });
                setCart([]);
                setPayments([{ metodo: 'efectivo', monto: 0 }]);
                setIsPaymentOpen(false);
                setTimeout(() => setMessage(null), 3000);
            } else {
                const error = await response.json();
                setMessage({ type: 'error', text: error.message || 'Error en la venta' });
            }
        } catch (error) {
            setMessage({ type: 'error', text: 'Error de conexi√≥n' });
        } finally {
            setLoading(false);
        }
    };

    return (
        <AppLayout breadcrumbs={breadcrumbs}>
            <Head title="POS" />
            <div className="grid gap-4 p-4 md:grid-cols-3">
                {/* Productos */}
                <div className="md:col-span-2 space-y-4">
                    <div className="relative">
                        <Input
                            ref={searchInputRef}
                            type="text"
                            placeholder="Buscar por nombre o SKU... (o escanea c√≥digo de barras)"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full pl-10"
                        />
                        <Scan className="absolute left-3 top-2.5 h-5 w-5 text-muted-foreground" />
                        {barcodeBuffer && (
                            <div className="absolute right-3 top-2.5 flex items-center gap-1">
                                <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" />
                                <span className="text-xs text-muted-foreground">Escaneando...</span>
                            </div>
                        )}
                    </div>

                    <div className="grid gap-2 md:grid-cols-2">
                        {filteredProducts.map((product) => (
                            <Card key={product.id} className="p-4">
                                <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                        <h4 className="font-semibold">{product.nombre}</h4>
                                        <p className="text-sm text-muted-foreground">SKU: {product.sku}</p>
                                        <p className="mt-2 text-lg font-bold">${product.precio_venta.toFixed(2)}</p>
                                        {product.iva_porcentaje > 0 && (
                                            <p className="text-xs text-gray-500">IVA: {product.iva_porcentaje}%</p>
                                        )}
                                    </div>
                                    <Button
                                        size="sm"
                                        onClick={() => addToCart(product)}
                                    >
                                        <Plus className="h-4 w-4" />
                                    </Button>
                                </div>
                            </Card>
                        ))}
                    </div>
                </div>

                {/* Carrito */}
                <div className="space-y-4">
                    <Card className="p-4">
                        <h3 className="mb-4 flex items-center gap-2 text-lg font-semibold">
                            <ShoppingCart className="h-5 w-5" />
                            Carrito ({cart.length})
                        </h3>

                        {message && (
                            <div
                                className={`mb-4 rounded p-3 text-sm ${
                                    message.type === 'success'
                                        ? 'bg-green-100 text-green-800'
                                        : 'bg-red-100 text-red-800'
                                }`}
                            >
                                {message.text}
                            </div>
                        )}

                        <div className="space-y-3 max-h-96 overflow-y-auto">
                            {cart.length === 0 ? (
                                <p className="text-center text-sm text-muted-foreground">Carrito vac√≠o</p>
                            ) : (
                                cart.map((item) => (
                                    <div key={item.id} className="space-y-2 border-b pb-3 last:border-0">
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <p className="text-sm font-medium">{item.nombre}</p>
                                                <p className="text-xs text-muted-foreground">
                                                    ${item.precio_venta.toFixed(2)} c/u
                                                </p>
                                            </div>
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                onClick={() => removeFromCart(item.id)}
                                            >
                                                <X className="h-4 w-4" />
                                            </Button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                            >
                                                ‚àí
                                            </Button>
                                            <Input
                                                type="number"
                                                min="1"
                                                value={item.quantity}
                                                onChange={(e) => updateQuantity(item.id, parseInt(e.target.value) || 1)}
                                                className="h-8 w-12 text-center"
                                            />
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                            >
                                                +
                                            </Button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {cart.length > 0 && (
                            <div className="mt-4 space-y-2 border-t pt-4">
                                <div className="flex justify-between text-sm">
                                    <span>Subtotal:</span>
                                    <span>${totals.subtotal.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span>Impuesto:</span>
                                    <span>${totals.tax.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between border-t pt-2 text-lg font-bold">
                                    <span>Total:</span>
                                    <span>${totals.total.toFixed(2)}</span>
                                </div>

                                <div className="flex gap-2">
                                    <Button 
                                        variant="outline" 
                                        className="flex-1"
                                        onClick={clearCart}
                                    >
                                        <Trash2 className="h-4 w-4 mr-2" />
                                        Limpiar
                                    </Button>
                                    <Dialog open={isPaymentOpen} onOpenChange={setIsPaymentOpen}>
                                        <DialogTrigger asChild>
                                            <Button className="flex-1">Pagar</Button>
                                        </DialogTrigger>
                                        <DialogContent className="max-w-md">
                                            <DialogHeader>
                                                <DialogTitle>Procesar Venta</DialogTitle>
                                            </DialogHeader>
                                            <div className="space-y-4">
                                                {/* Resumen de Total */}
                                                <div className="rounded-lg bg-gray-100 dark:bg-gray-800 p-4">
                                                    <p className="text-sm text-muted-foreground">Total a Pagar</p>
                                                    <p className="text-3xl font-bold">${totals.total.toFixed(2)}</p>
                                                </div>

                                                {/* M√©todo de Pago Principal */}
                                                <div className="space-y-2">
                                                    <Label>M√©todo de Pago</Label>
                                                    <Select
                                                        value={payments[0].metodo}
                                                        onValueChange={(value) => handlePaymentChange(0, 'metodo', value)}
                                                    >
                                                        <SelectTrigger>
                                                            <SelectValue />
                                                        </SelectTrigger>
                                                        <SelectContent>
                                                            <SelectItem value="efectivo">üíµ Efectivo</SelectItem>
                                                            <SelectItem value="tarjeta">üí≥ Tarjeta</SelectItem>
                                                            <SelectItem value="transferencia">üè¶ Transferencia</SelectItem>
                                                        </SelectContent>
                                                    </Select>
                                                </div>

                                                {/* Si es Efectivo, mostrar campo de monto recibido y cambio */}
                                                {payments[0].metodo === 'efectivo' && (
                                                    <div className="space-y-3">
                                                        <div className="space-y-2">
                                                            <Label>Monto Recibido</Label>
                                                            <Input
                                                                type="number"
                                                                step="0.01"
                                                                placeholder="0.00"
                                                                value={montoRecibido || ''}
                                                                onChange={(e) => {
                                                                    const valor = parseFloat(e.target.value) || 0;
                                                                    setMontoRecibido(valor);
                                                                    handlePaymentChange(0, 'monto', valor);
                                                                }}
                                                                className="text-lg"
                                                                autoFocus
                                                            />
                                                        </div>

                                                        {/* Botones r√°pidos */}
                                                        <div className="grid grid-cols-4 gap-2">
                                                            {[5000, 10000, 20000, 50000].map((amount) => (
                                                                <Button
                                                                    key={amount}
                                                                    variant="outline"
                                                                    size="sm"
                                                                    onClick={() => {
                                                                        setMontoRecibido(amount);
                                                                        handlePaymentChange(0, 'monto', amount);
                                                                    }}
                                                                    className="text-xs"
                                                                >
                                                                    ${(amount/1000).toFixed(0)}K
                                                                </Button>
                                                            ))}
                                                        </div>

                                                        {/* Cambio */}
                                                        {montoRecibido > 0 && (
                                                            <div className={`rounded-lg p-4 ${
                                                                montoRecibido >= totals.total 
                                                                    ? 'bg-green-100 dark:bg-green-900' 
                                                                    : 'bg-red-100 dark:bg-red-900'
                                                            }`}>
                                                                <p className="text-sm font-medium">
                                                                    {montoRecibido >= totals.total ? '‚úì Cambio' : '‚ö†Ô∏è Falta'}
                                                                </p>
                                                                <p className="text-2xl font-bold">
                                                                    ${Math.abs(montoRecibido - totals.total).toFixed(2)}
                                                                </p>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}

                                                {/* Para otros m√©todos, solo confirmar el monto */}
                                                {payments[0].metodo !== 'efectivo' && (
                                                    <div className="space-y-2">
                                                        <Label>Monto</Label>
                                                        <Input
                                                            type="number"
                                                            step="0.01"
                                                            value={payments[0].monto || totals.total}
                                                            onChange={(e) => handlePaymentChange(0, 'monto', parseFloat(e.target.value) || 0)}
                                                            className="text-lg"
                                                        />
                                                    </div>
                                                )}

                                                {/* Bot√≥n agregar otro m√©todo de pago */}
                                                {payments.length === 1 && (
                                                    <Button 
                                                        variant="outline" 
                                                        onClick={addPaymentMethod} 
                                                        className="w-full"
                                                        size="sm"
                                                    >
                                                        + Pago Combinado
                                                    </Button>
                                                )}

                                                {/* M√©todos adicionales */}
                                                {payments.length > 1 && (
                                                    <div className="space-y-2 border-t pt-3">
                                                        <p className="text-sm font-medium">Pagos Adicionales</p>
                                                        {payments.slice(1).map((payment, index) => (
                                                            <div key={index + 1} className="flex gap-2 items-end">
                                                                <div className="flex-1">
                                                                    <Select
                                                                        value={payment.metodo}
                                                                        onValueChange={(value) =>
                                                                            handlePaymentChange(index + 1, 'metodo', value)
                                                                        }
                                                                    >
                                                                        <SelectTrigger className="h-9">
                                                                            <SelectValue />
                                                                        </SelectTrigger>
                                                                        <SelectContent>
                                                                            <SelectItem value="efectivo">Efectivo</SelectItem>
                                                                            <SelectItem value="tarjeta">Tarjeta</SelectItem>
                                                                            <SelectItem value="transferencia">Transferencia</SelectItem>
                                                                        </SelectContent>
                                                                    </Select>
                                                                </div>
                                                                <Input
                                                                    type="number"
                                                                    step="0.01"
                                                                    placeholder="0.00"
                                                                    value={payment.monto || ''}
                                                                    onChange={(e) =>
                                                                        handlePaymentChange(index + 1, 'monto', parseFloat(e.target.value) || 0)
                                                                    }
                                                                    className="w-28 h-9"
                                                                />
                                                                <Button
                                                                    variant="ghost"
                                                                    size="sm"
                                                                    onClick={() => removePaymentMethod(index + 1)}
                                                                    className="h-9"
                                                                >
                                                                    <X className="h-4 w-4" />
                                                                </Button>
                                                            </div>
                                                        ))}
                                                        <Button variant="outline" onClick={addPaymentMethod} size="sm" className="w-full">
                                                            + Otro M√©todo
                                                        </Button>
                                                    </div>
                                                )}

                                                {/* Validaci√≥n y confirmaci√≥n */}
                                                <div className="border-t pt-3 space-y-2">
                                                    <div className="flex justify-between text-sm">
                                                        <span>Total a Pagar:</span>
                                                        <span className="font-bold">${totals.total.toFixed(2)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span>Total Recibido:</span>
                                                        <span className="font-bold">
                                                            ${(payments.reduce((sum, p) => sum + (p.monto || 0), 0)).toFixed(2)}
                                                        </span>
                                                    </div>
                                                </div>

                                                <Button 
                                                    onClick={submitSale} 
                                                    disabled={loading || (payments[0].metodo === 'efectivo' && montoRecibido < totals.total)} 
                                                    className="w-full"
                                                    size="lg"
                                                >
                                                    {loading ? 'Procesando...' : '‚úì Confirmar Venta'}
                                                </Button>
                                            </div>
                                        </DialogContent>
                                    </Dialog>
                                </div>
                            </div>
                        )}
                    </Card>
                </div>
            </div>
        </AppLayout>
    );
}
